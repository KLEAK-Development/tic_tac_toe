name: CI (Main)

on:
  push:
    branches: [main]

jobs:
  setup-and-validation:
    name: Setup & Validation
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.flutter-channel != 'stable' }}
    strategy:
      matrix:
        flutter-channel: [stable, beta, master]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter (${{ matrix.flutter-channel }})
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-channel == 'stable' && '3.35.7' || '' }}
          channel: ${{ matrix.flutter-channel }}
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Generate localizations
        run: flutter gen-l10n

      - name: Run static analysis
        run: flutter analyze

  unit-widget-tests:
    name: Unit & Widget Tests
    runs-on: ubuntu-latest
    needs: setup-and-validation
    continue-on-error: ${{ matrix.flutter-channel != 'stable' }}
    strategy:
      matrix:
        flutter-channel: [stable, beta, master]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter (${{ matrix.flutter-channel }})
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-channel == 'stable' && '3.35.7' || '' }}
          channel: ${{ matrix.flutter-channel }}
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Generate localizations
        run: flutter gen-l10n

      - name: Run tests with coverage
        run: flutter test --coverage --concurrency 4

      - name: Upload coverage reports to Codecov
        if: matrix.flutter-channel == 'stable'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: false

      - name: Upload coverage artifact
        if: matrix.flutter-channel == 'stable'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.flutter-channel }}
          path: coverage/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: setup-and-validation
    continue-on-error: ${{ matrix.flutter-channel != 'stable' }}
    strategy:
      matrix:
        flutter-channel: [stable, beta, master]
        target:
          - integration_test/two_player_game_test.dart
          - integration_test/locale_switching_basic_test.dart
          - integration_test/locale_switching_comprehensive_test.dart
      fail-fast: false
    env:
      CHROMIUM_FLAGS: "--headless --no-sandbox --disable-gpu --disable-dev-shm-usage"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter (${{ matrix.flutter-channel }})
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-channel == 'stable' && '3.35.7' || '' }}
          channel: ${{ matrix.flutter-channel }}
          cache: true

      - name: Setup ChromeDriver
        uses: nanasess/setup-chromedriver@master

      - name: Start ChromeDriver
        run: |
          export DISPLAY=:99
          chromedriver --port=4444 &

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Cache Flutter/Dart build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.dartServer/.analysis-driver
            .dart_tool
            build
          key: ${{ runner.os }}-flutter-build-${{ matrix.flutter-channel }}-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('integration_test/**') }}
          restore-keys: |
            ${{ runner.os }}-flutter-build-${{ matrix.flutter-channel }}-

      - name: Generate localizations
        run: flutter gen-l10n

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Run integration test (${{ matrix.target }})
        run: |
          (flutter drive \
            --no-pub \
            --driver=test_driver/integration_test.dart \
            --target=${{ matrix.target }} \
            --web-renderer=html \
            -d web-server) || \
          (flutter drive \
            --no-pub \
            --driver=test_driver/integration_test.dart \
            --target=${{ matrix.target }} \
            --web-renderer=html \
            -d web-server)

  build-web:
    name: Build Web Release
    runs-on: ubuntu-latest
    needs: [unit-widget-tests, integration-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.7"
          channel: stable
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Generate localizations
        run: flutter gen-l10n

      - name: Build web release
        run: |
          flutter build web \
            --base-href /tic_tac_toe/ \
            --target lib/production.dart

      - name: Upload web build for Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: build/web

  deploy:
    permissions:
      contents: read
      pages: write
      id-token: write
    runs-on: ubuntu-latest
    needs: build-web
    environment:
      name: github-pages
      url: ${{steps.deployment.outputs.page_url}}
    steps:
      - name: Deploy artifact
        id: deployment
        uses: actions/deploy-pages@v4


